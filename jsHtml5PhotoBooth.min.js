/**
 * Object:  jsHtml5VideoRecorder
 * Version: master
 * Author:  Edouard Kombo
 * Twitter: @EdouardKombo
 * Github:  https://github.com/edouardkombo
 * Blog:    http://creativcoders.wordpress.com
 * Url:     https://github.com/edouardkombo/jsHtml5VideoRecorder
 * 
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 * 
 * Take snapshots from webcam stream in html5 with many features. Apply watermark, rotation and directly print the picture (local environments only)
 */

jsHtml5PhotoBooth.prototype={url:0,hasStopped:false,mediaStream:"",resultTagId:"myPicture",videoTagId:"video",canvasTagId:"canvas",videoTag:0,canvasTag:0,ctx:0,width:0,height:0,mediaPath:"",phpFile:"",resultTagIdHost:"",videoTagIdHost:"",pictureExtension:"",pictureResource:"",pictureQuality:"",showStreamOnFinish:true,hideWebcamWhileSnapshot:true,captureFromCanvas:false,printPictureOnFinish:false,printPhpFile:"",printOptionComputerName:"",printOptionSharedPrinterName:"",watermarkImage:false,rotation:false,printBatchFile:"",init:function(){if(!navigator.getUserMedia){navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia}window.URL=window.URL||window.webkitURL;this.url=window.URL;window.onload=this.onLoad()},onLoad:function(){navigator.getUserMedia({video:true},this.startUserMedia.bind(this),function(e){console.log("No live video stream: "+e);alert("Webcam not enabled or no live video stream")})},startUserMedia:function(e){this.mediaStream=e;this.resetTags()},resetTags:function(){this.createTag("video",this.videoTagId);this.createTag("canvas",this.canvasTagId)},createTag:function(e,t){var n=document.getElementById(t);if(n===null){n=document.createElement(e);if(e==="canvas"){n.width=this.width;n.height=this.height;n.id=t;n.style.position="absolute";n.style.visibility="hidden";this.ctx=n.getContext("2d");this.canvasTag=this.ctx.canvas}else if(e==="video"){n.setAttribute("autoplay","true");n.width=this.width;n.height=this.height;n.id=t;if(this.mediaStream!==""){n.src=window.URL.createObjectURL(this.mediaStream)}this.videoTag=n}document.getElementById(this.videoTagIdHost).appendChild(n)}},startCapture:function(){var e=document.getElementById(this.resultTagId);if(e){e.remove()}if(this.hideWebcamWhileSnapshot){this.showHideStream("hide")}this.hasStopped=false;if(false===this.captureFromCanvas){this.ctx.drawImage(this.videoTag,0,0,this.videoTag.width,this.videoTag.height)}var t=this.canvasTag.toDataURL("image/"+this.pictureExtension,this.pictureQuality);this.pictureResource=t;return true},showHideStream:function(e){if(e==="show"){this.videoTag.style.visibility="visible";this.videoTag.style.display="block"}else if(e==="hide"){this.videoTag.style.visibility="hidden";this.videoTag.style.display="none"}},stopCapture:function(e){if(e==="save"){this.save(this.pictureResource,false)}else if(e==="download"){this.download(this.pictureResource,false)}else if(e==="stream"){this.stream(this.pictureResource)}else if(e==="saveAndDownload"){this.save(this.pictureResource,false);this.download(this.pictureResource,false)}else if(e==="saveAndStream"){this.save(this.pictureResource,true)}else if(e==="downloadAndStream"){this.download(this.pictureResource,true)}else{this.save(this.pictureResource,false)}if(this.showStreamOnFinish){this.showHideStream("show")}return true},save:function(e,t){var n="path="+this.mediaPath+"&type=picture&extension="+this.pictureExtension+"&watermark="+this.watermarkImage+"&rotation="+this.rotation;var r=new XMLHttpRequest;r.onreadystatechange=function(){if(r.readyState===4&&r.status===200){console.log(r.response);var e=this.rotation||this.watermarkImage?r.response+"?time="+Date.now():this.pictureResource;if(this.printPictureOnFinish){this.printPicture(r.response)}if(t){this.stream(e)}}}.bind(this);r.open("post",this.phpFile+"?"+n,true);r.setRequestHeader("X-Requested-With","XMLHttpRequest");r.setRequestHeader("cache-Control","no-store, no-cache, must-revalidate");r.setRequestHeader("cache-Control","post-check=0, pre-check=0");r.setRequestHeader("cache-Control","max-age=0");r.setRequestHeader("Pragma","no-cache");r.setRequestHeader("X-File-Name",encodeURIComponent("1"));r.setRequestHeader("Content-Type","application/octet-stream");r.send(e)},printPicture:function(e){var t=e.replace(this.mediaPath,"");var n="printBatch="+this.printBatchFile+"&mediaPath="+this.mediaPath+"&pictureName="+t+"&computerName="+this.printOptionComputerName+"&sharedPrinterName="+this.printOptionSharedPrinterName;var r=new XMLHttpRequest;r.onreadystatechange=function(){if(r.readyState===4&&r.status===200){console.log(r.response)}}.bind(this);r.open("post",this.printPhpFile+"?"+n,true);r.setRequestHeader("X-Requested-With","XMLHttpRequest");r.setRequestHeader("cache-Control","no-store, no-cache, must-revalidate");r.setRequestHeader("cache-Control","post-check=0, pre-check=0");r.setRequestHeader("cache-Control","max-age=0");r.setRequestHeader("Pragma","no-cache");r.setRequestHeader("X-File-Name",encodeURIComponent("1"));r.setRequestHeader("Content-Type","application/octet-stream");r.send()},download:function(e,t){var n=document.createElement("a");var r=(new Date).toISOString();n.href=e;n.id=r;n.download=r+this.pictureExtension;n.innerHTML=n.download;n.style.display="none";n.style.visibility="hidden";document.body.appendChild(n);document.getElementById(n.id).click();document.getElementById(n.id).remove();if(t){this.stream(e)}},stream:function(e){var t=document.createElement("img");t.src=e;t.id=this.resultTagId;document.getElementById(this.resultTagIdHost).appendChild(t)}}