/**
 * Object:  jsHtml5PhotoBooth
 * Version: master
 * Author:  Edouard Kombo
 * Twitter: @EdouardKombo
 * Github:  https://github.com/edouardkombo
 * Blog:    http://creativcoders.wordpress.com
 * Url:     https://github.com/edouardkombo/jsHtml5PhotoBooth
 * 
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 * 
 * Take snapshots from webcam stream in html5 with many features. Apply watermark, rotation and directly print the picture (local environments only)
 */

var jsHtml5PhotoBooth=function(){};jsHtml5PhotoBooth.prototype={url:0,hasStopped:false,mediaStream:"",videoTagId:"video",canvasTagId:"canvas",videoTag:0,canvasTag:0,ctx:0,width:0,height:0,mediaPath:"",phpFile:"",videoTagIdHost:"",pictureExtension:"",pictureResource:"",pictureQuality:"",hideWebcamWhileSnapshot:true,captureFromCanvas:false,printPhpFile:"",printOptionSharedPrinterName:"",watermarkImage:false,rotation:false,fileName:"",client:"",callback:"",callbackType:"",urlToStream:"",init:function(){if(!navigator.getUserMedia){navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia}window.URL=window.URL||window.webkitURL;this.url=window.URL;window.onload=this.onLoad()},onLoad:function(){navigator.getUserMedia({video:true},this.startUserMedia.bind(this),function(e){console.log("No live video stream: "+e);alert("Webcam not enabled or no live video stream")})},startUserMedia:function(e){this.mediaStream=e;this.resetTags()},resetTags:function(){this.createTag("video",this.videoTagId);this.createTag("canvas",this.canvasTagId)},createTag:function(e,t){var n=document.getElementById(t);if(n===null){n=document.createElement(e);if(e==="canvas"){n.width=this.width;n.height=this.height;n.id=t;n.style.position="absolute";n.style.visibility="hidden";this.ctx=n.getContext("2d");this.canvasTag=this.ctx.canvas}else if(e==="video"){n.setAttribute("autoplay","true");n.width=this.width;n.height=this.height;n.id=t;if(this.mediaStream!==""){n.src=window.URL.createObjectURL(this.mediaStream)}this.videoTag=n}document.getElementById(this.videoTagIdHost).appendChild(n)}else{if(e==="canvas"){this.canvasTag=n;this.canvasTag.id=t;this.canvasTag.width=this.width;this.canvasTag.height=this.height}else{this.videoTag=n;this.videoTag.setAttribute("autoplay","true");if(this.mediaStream!==""){this.videoTag.src=window.URL.createObjectURL(this.mediaStream)}this.videoTag.id=t;this.videoTag.width=this.width;this.videoTag.height=this.height}}},setFileName:function(){this.fileName=Date.now()},startRecording:function(){if(this.hideWebcamWhileSnapshot){this.showHideStream("hide")}this.hasStopped=false;if(false===this.captureFromCanvas){this.ctx.drawImage(this.videoTag,0,0,this.videoTag.width,this.videoTag.height)}var e=this.canvasTag.toDataURL("image/"+this.pictureExtension,this.pictureQuality);this.pictureResource=e;return true},showHideStream:function(e){if(e==="show"){this.videoTag.style.visibility="visible";this.videoTag.style.display="block"}else if(e==="hide"){this.videoTag.style.visibility="hidden";this.videoTag.style.display="none"}},stopRecording:function(e){this.setFileName();this.save(this.pictureResource);if(e==="download"){this.download(this.pictureResource)}this.showHideStream("show");return true},xhr:function(e,t){this.client=new XMLHttpRequest;this.client.onreadystatechange=function(){if(this.client.readyState===4&&this.client.status===200){console.log(this.client.response);this.urlToStream=this.mediaPath+this.fileName+"/"+this.fileName+"."+this.pictureExtension;this.callbackType="picture";var e=window[this.callback];e();this.showHideStream("show")}}.bind(this);this.client.open("post",e);this.client.setRequestHeader("X-Requested-With","XMLHttpRequest");this.client.setRequestHeader("cache-Control","no-store, no-cache, must-revalidate");this.client.setRequestHeader("cache-Control","post-check=0, pre-check=0");this.client.setRequestHeader("cache-Control","max-age=0");this.client.setRequestHeader("Pragma","no-cache");this.client.send(t)},save:function(e){var t=new FormData;t.append("picture-blob",e);t.append("extension",this.pictureExtension);t.append("watermark",this.watermarkImage);t.append("rotation",this.rotation);t.append("path",this.mediaPath);t.append("filename",this.fileName);t.append("sharedPrinterName",this.printOptionSharedPrinterName);this.xhr(this.phpFile,t)},download:function(e){var t=document.createElement("a");var n=(new Date).toISOString();t.href=e;t.id=n;t.download=n+"."+this.pictureExtension;t.innerHTML=t.download;t.style.display="none";t.style.visibility="hidden";document.body.appendChild(t);document.getElementById(t.id).click();document.getElementById(t.id).remove()}}